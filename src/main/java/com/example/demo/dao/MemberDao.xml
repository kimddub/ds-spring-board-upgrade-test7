<?xml version="1.0" encoding="UTF-8"?>

<!-- XML mapper dtd 등록 -->
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.example.demo.dao.MemberDao">

	<insert id="insertMember" parameterType="map">
		INSERT INTO `member`(regDate, loginId, encryptedLoginPw, encryptingSalt, `name`, authCode)
		VALUES (NOW(), #{loginId}, #{encryptedLoginPw}, #{encryptingSalt}, #{name}, #{authCode})
	</insert>

	<select id="selecetMember" resultType="com.example.demo.dto.Member">
		SELECT *
		FROM `member`
		WHERE 1=1
	</select>
	
	<select id="selectOneMember" parameterType="map" resultType="com.example.demo.dto.Member">
		SELECT *
		FROM `member`
		WHERE 1=1
		<if test="where__id != null and where__id == 'true'">
			AND id = #{memberId} AND withdrawal = 0
		</if>
		<if test="where__loginId != null and where__loginId == 'true'">
			AND loginId = #{loginId}
		</if>
		<if test="where__loginIdAndLoginPw != null and where__loginIdAndLoginPw == 'true'">
			AND loginId = #{loginId} AND encryptedLoginPw = #{encryptedLoginPw} AND withdrawal = 0
		</if>
	</select>

	<select id="getList" resultMap="Article">
		SELECT a1.*, a2.onlyRegDate
		FROM article AS a1
		LEFT JOIN (
			SELECT id, DATE_FORMAT(regDate,"%Y-%m-%d") AS 'onlyRegDate'
			FROM article
		) AS a2
		ON a1.id = a2.id
		WHERE a1.delState != 1
		<if test="searchMode != null and searchMode == 'true'">
			<if test="searchType == 'title'"> AND a1.`title` LIKE CONCAT('%', #{searchKey}, '%') </if>
			<if test="searchType == 'body'"> AND a1.`body` LIKE CONCAT('%', #{searchKey}, '%') </if>
			<if test="searchType == 'writer'"> AND a1.`writer` LIKE CONCAT('%', #{searchKey}, '%') </if>
		</if>
		ORDER BY a1.`regDate` DESC, a1.id DESC
		LIMIT #{prevPageArticles}, #{perPageArticles}
	</select>
	
	
  	<resultMap id="Article" type="com.example.demo.dto.Article">
  		<result property="id" column="id"/>
  		<result property="regDate" column="regDate"/>
  		<result property="modDate" column="modDate"/>
  		<result property="title" column="title"/>
  		<result property="body" column="body"/>
  		<result property="boardId" column="boardId"/>
  		<result property="writer" column="writer"/>
  		<result property="delState" column="delState"/>
  		<association property="extra" javaType="java.util.HashMap">
  			<result property="onlyRegDate" column="onlyRegDate"/>
  		</association>
  	</resultMap> 
</mapper>